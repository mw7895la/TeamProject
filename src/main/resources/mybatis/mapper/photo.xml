<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.mapper.photo">

	<insert id="insertRegPhoto" parameterType="registerPhoto">
	
		<selectKey order="BEFORE" resultType="int" keyProperty="pnumber">
			select SEQ_REGPHOTO_PNUMBER.nextval from dual
		</selectKey>
		
		insert into register_photo (pnumber, REGISTER_PDATE, PHIT_COUNT, PWRITER, PTYPE,PSIZE,PSTYLE, FIRST_IMAGE, first_content) 
		values (SEQ_REGPHOTO_PNUMBER.currval, sysdate, 0, #{pwriter},#{ptype},#{psize},#{pstyle}, #{first_image}, #{first_content})
	</insert>
	
	
	
	<insert id="insertAPhoto" parameterType="aPhoto">

		insert into A_PHOTO (ANUMBER, AIMAGE, ACONTENT, ALOCATION, REGISTER_NUMBER) 
		values (SEQ_APHOTO_ANUMBER.nextval, #{aimage}, #{acontent}, #{alocation},#{register_number})
	</insert>
	
	<select id="selectList" resultType="registerPhoto">
		select pnumber, first_image from register_photo
	</select>
	
	<select id="selectAphotoList" parameterType="int" resultType="aPhoto">
		select * from A_PHOTO where REGISTER_NUMBER = #{pnumber}
		
	</select>
	
	<select id="selectRegPhoto" parameterType="int" resultType="registerPhoto">
		select PNUMBER, REGISTER_PDATE, PHIT_COUNT, PWRITER, PTYPE, PSIZE, PSTYLE, mnickname, FIRST_IMAGE, mimage, 
		(select count(*) from post_bookmark where pnumber = #{pnumber}) bookcount, 
		(select count(*) from post_like where pnumber = #{pnumber}) likecount
		from REGISTER_PHOTO r, member m 
		where r.pwriter = m.memail and pnumber = #{pnumber}
	</select>
	
	<select id="selectcheckRegPhoto" parameterType="registerPhoto" resultType="registerPhoto">
		select PNUMBER, REGISTER_PDATE, PHIT_COUNT, PWRITER, PTYPE, PSIZE, PSTYLE, mnickname, FIRST_IMAGE, mimage, 
		(select count(*) from post_bookmark where pnumber = #{pnumber}) bookcount, 
		(select count(*) from post_like where pnumber = #{pnumber}) likecount,
		(select count(*) from post_bookmark where memail = #{pwriter} and pnumber = #{pnumber}) bnumber, 
		(select count(*) from post_like where memail = #{pwriter} and pnumber = #{pnumber}) likenumber
		from REGISTER_PHOTO r, member m 
		where r.pwriter = m.memail and pnumber = #{pnumber}
	</select>
	
	<select id="countAll" resultType="int">
		select count(*)from register_photo
	</select>
	
	<select id="selectByPage" resultType="registerPhoto" parameterType="pager">
		select rnum, pnumber, first_image, PHIT_COUNT, PTYPE, PSIZE, PSTYLE, mnickname, first_content, MIMAGE
		from(
		select rownum as rnum, pnumber, first_image, PHIT_COUNT, PTYPE, PSIZE, PSTYLE, mnickname, first_content, MIMAGE
		from (
		select pnumber, first_image, PHIT_COUNT, PTYPE, PSIZE, PSTYLE, mnickname, first_content,MIMAGE
		from register_photo r, member m
		where r.PWRITER = m.MEMAIL order by pnumber desc)
		where rownum &lt;= #{endRowNo}
		)
		where rnum &gt;= #{startRowNo} 
	</select>
	
	<select id="selectCheckByPageList" resultType="registerPhoto" parameterType="registerPhoto">
		select rnum, pnumber , first_image, PHIT_COUNT, PTYPE, PSIZE, PSTYLE, mnickname, first_content,MIMAGE, bnumber, LIKENUMBER,FOLLOWING, pwriter
		from( select rownum as rnum, list.pnumber, first_image, PHIT_COUNT, PTYPE, PSIZE, PSTYLE, mnickname, first_content, MIMAGE, bnumber, LIKENUMBER ,FOLLOWING, pwriter
		from 
		( select pnumber, first_image, PHIT_COUNT, PTYPE, PSIZE, PSTYLE, mnickname, first_content,MIMAGE, PWRITER from register_photo r, member m where r.PWRITER = m.MEMAIL order by pnumber desc) list, 
		(select * from post_bookmark where memail = #{pwriter}) pb, 
		(select * from post_like where memail = #{pwriter}) pl,
		(select FOLLOWING from FOLLOWS where FOLLOWER = #{pwriter}) fl
		where rownum &lt;= #{endRowNo} and list.pnumber = pb.pnumber(+) and list.pnumber = pl.pnumber(+) and list.pwriter = fl.FOLLOWING(+)) 
		where rnum &gt;= #{startRowNo}
	</select>
	
	<update id="updateHitCount" parameterType="registerPhoto">
		UPDATE REGISTER_PHOTO SET PHIT_COUNT = #{phit_count} WHERE PNUMBER = #{pnumber}
	</update>
</mapper>